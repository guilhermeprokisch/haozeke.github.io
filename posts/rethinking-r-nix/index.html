<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="[Rohit Goswami]">
<meta name="description" content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &amp;ldquo;Statistical Rethinking&amp;rdquo; by Richard McElreath.
 Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post." />
<meta name="keywords" content=", tools, nix, workflow, R" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://rgoswami.me/posts/rethinking-r-nix/" />


<title>
    
    Statistical Rethinking and Nix :: Rohit Goswami  — Reflections
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
      type="text/css">



<link rel="stylesheet" href="https://rgoswami.me/main.min.7bfbbe12786fa0ded4b4c0d792cbb36a5bd0bdb0b856dde57aa7b1f6fe0f2b87.css">






<meta itemprop="name" content="Statistical Rethinking and Nix">
<meta itemprop="description" content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &ldquo;Statistical Rethinking&rdquo; by Richard McElreath.
 Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post.">


<meta itemprop="datePublished" content="2020-06-07T04:24:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-06-14T01:25:34&#43;00:00" />
<meta itemprop="wordCount" content="2180">



<meta itemprop="keywords" content="tools,nix,workflow,R," />
<meta property="og:title" content="Statistical Rethinking and Nix" />
<meta property="og:description" content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &ldquo;Statistical Rethinking&rdquo; by Richard McElreath.
 Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rgoswami.me/posts/rethinking-r-nix/" />

<meta property="og:image" content="https://rgoswami.me" />
<meta property="article:published_time" content="2020-06-07T04:24:00+00:00" />
<meta property="article:modified_time" content="2020-06-14T01:25:34+00:00" /><meta property="og:site_name" content="Rohit Goswami" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rgoswami.me"/>

<meta name="twitter:title" content="Statistical Rethinking and Nix"/>
<meta name="twitter:description" content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &ldquo;Statistical Rethinking&rdquo; by Richard McElreath.
 Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post."/>



    <meta property="article:section" content="programming" />



    <meta property="article:published_time" content="2020-06-07 04:24:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <div class="header__inner">
            <div class="logo">
<a href="https://rgoswami.me/" style="text-decoration: none;">
        
            <img src="https://rgoswami.me/images/home.png" alt="" />
        
</a>
    </div>


        
        <div class="button">
            <div class="button__text">
        <a href="https://rgoswami.me/search" >
                Search
        </a>
            </div>
        </div>
       

        <div class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://rgoswami.me/about">About</a></li><li><a href="https://rgoswami.me/posts">Blog</a></li>
    </ul>
    <ul class="menu__inner"><li><a href="https://rgoswami.me/categories">Categories</a></li><li><a href="https://rgoswami.me/tags">Tags</a></li>
    </ul>
</nav>

                <div class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </div>
            

            <div class="theme-toggle unselectable"><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</div>
        </div>
    </div>
</header>

            
<script src="https://rgoswami.me/js/mathjax-config.js"></script>


<script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-chtml.js"></script>

            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>11 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://rgoswami.me/posts/rethinking-r-nix/">Statistical Rethinking and Nix</a>
            </h1>
                <hr />
                <aside id="toc">
                <div class="toc-title">Table of Contents</div>
                    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#background">Background</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#introspection">Introspection</a></li>
</ul></li>
<li><a href="#towards-reproducible-environments">Towards Reproducible Environments</a>
<ul>
<li><a href="#niv-and-pinning">Niv and Pinning</a></li>
<li><a href="#lorri-and-direnv">Lorri and Direnv</a></li>
</ul></li>
<li><a href="#rethinking">Rethinking</a></li>
<li><a href="#conclusions">Conclusions</a></li>
</ul></li>
</ul>
</nav>
                </aside>
                <hr />

            

            <div class="post-content">
                

<blockquote>
<p>This post describes how to set up a transparent automated setup for reproducible
<code>R</code> workflows using <code>nixpkgs</code>, <code>niv</code>, and <code>lorri</code>. The explanatory example used
throughout the post is one of setting up the <code>rethinking</code> package and running
some examples
from the <a href="https://xcelab.net/rm/statistical-rethinking/" target="_blank">excellent second edition</a> of &ldquo;Statistical
Rethinking&rdquo; by <a href="https://twitter.com/rlmcelreath" target="_blank">Richard McElreath</a>.</p>
</blockquote>

<h2 id="background">Background</h2>

<p>As detailed <a href="https://rgoswami.me/posts/nix-r-devtools/" target="_blank">in an earlier post</a><sup class="footnote-ref" id="fnref:fn-1"><a href="#fn:fn-1">1</a></sup>, I had set up Nix to work with
non-CRAN packages. If the rest of this section is unclear, please refer back to <a href="https://rgoswami.me/posts/nix-r-devtools/" target="_blank">the earlier post</a>.</p>

<h3 id="setup">Setup</h3>

<p>For the remainder of the post, we will set up a basic project structure:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir tryRnix/</code></pre></div>
<p>Now we will create a <code>shell.nix</code> as<sup class="footnote-ref" id="fnref:fn-2"><a href="#fn:fn-2">2</a></sup>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nix" data-lang="nix"><span style="color:#999;font-style:italic"># shell.nix</span>
{ pkgs ? <span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">&lt;nixpkgs&gt;</span> { } }:
<span style="color:#6ab825;font-weight:bold">with</span> pkgs;
<span style="color:#6ab825;font-weight:bold">let</span>
  my-r-pkgs = rWrapper.override {
    packages = <span style="color:#6ab825;font-weight:bold">with</span> rPackages; [
      ggplot2
      tidyverse
      tidybayes
      tidybayes.rethinking
      (buildRPackage {
        name = <span style="color:#ed9d13">&#34;rethinking&#34;</span>;
        src = fetchFromGitHub {
          owner = <span style="color:#ed9d13">&#34;rmcelreath&#34;</span>;
          repo = <span style="color:#ed9d13">&#34;rethinking&#34;</span>;
          rev = <span style="color:#ed9d13">&#34;d0978c7f8b6329b94efa2014658d750ae12b1fa2&#34;</span>;
          sha256 = <span style="color:#ed9d13">&#34;1qip6x3f6j9lmcmck6sjrj50a5azqfl6rfhp4fdj7ddabpb8n0z0&#34;</span>;
        };
        propagatedBuildInputs = [ coda MASS mvtnorm loo shape rstan dagitty ];
      })
    ];
  };
<span style="color:#6ab825;font-weight:bold">in</span> mkShell {
  buildInputs = <span style="color:#6ab825;font-weight:bold">with</span> pkgs; [ git glibcLocales openssl which openssh curl wget ];
  inputsFrom = [ my-r-pkgs ];
  shellHook = <span style="color:#ed9d13">&#39;&#39;
</span><span style="color:#ed9d13">    mkdir -p &#34;$(pwd)/_libs&#34;
</span><span style="color:#ed9d13">    export R_LIBS_USER=&#34;$(pwd)/_libs&#34;
</span><span style="color:#ed9d13">  &#39;&#39;</span>;
  GIT_SSL_CAINFO = <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>cacert<span style="color:#ed9d13">}</span><span style="color:#ed9d13">/etc/ssl/certs/ca-bundle.crt&#34;</span>;
  LOCALE_ARCHIVE = stdenv.lib.optionalString stdenv.isLinux
    <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>glibcLocales<span style="color:#ed9d13">}</span><span style="color:#ed9d13">/lib/locale/locale-archive&#34;</span>;
}</code></pre></div>
<p>So we have:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tree tryRnix</code></pre></div>
<table>
<thead>
<tr>
<th>tryRnix</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>└──</td>
<td>shell.nix</td>
<td></td>
<td></td>
</tr>

<tr>
<td>0</td>
<td>directories,</td>
<td>1</td>
<td>file</td>
</tr>
</tbody>
</table>

<h3 id="introspection">Introspection</h3>

<p>At this point:</p>

<ul>
<li>I was able to install packages (system and <code>R</code>) arbitrarily</li>
<li>I was able to use project specific folders</li>
<li>Unlike <code>npm</code>, <code>pipenv</code>, <code>poetry</code>, <code>conda</code> and friends, my system was not bloated by downloading and setting up the same packages every-time I used them in different projects</li>
</ul>

<p>However, though this is a major step up from being chained to RStudio and my
system package manager, it is still perhaps not immediately obvious how this
workflow is reproducible. Admittedly, I have defined my packages in a nice
functional manner; but someone else might have a different upstream channel they
are tracking, and thus will have different packages. Indeed the only packages
which I could be sure of were the <code>R</code> packages I built from Github, since those
were tied to a hash. Finally, the setup described for each project is pretty
onerous, and it is not immediately clear how to leverage fantastic tools like
<code>direnv</code> for working through this.</p>

<h2 id="towards-reproducible-environments">Towards Reproducible Environments</h2>

<p>The astute reader will have noticed that I mentioned that the <code>R</code> packages were
reproducible since they were tied to a <strong>hash</strong>, and might reasonable argue that
the entire Nix ecosystem is about <strong>hashing</strong> in the first place. Once we realize
that, the rest is relatively simple<sup class="footnote-ref" id="fnref:fn-3"><a href="#fn:fn-3">3</a></sup>.</p>

<h3 id="niv-and-pinning">Niv and Pinning</h3>

<p><a href="https://github.com/nmattia/niv/" target="_blank">Niv</a> essentially keeps track of the channel from which all the packages are installed. Setup is pretty minimal.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#24909d">cd</span> tryRnix/
nix-env -i niv
niv init</code></pre></div>
<p>At this point, we have:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tree tryRnix</code></pre></div>
<table>
<thead>
<tr>
<th>tryRnix</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>├──</td>
<td>nix</td>
<td></td>
<td></td>
</tr>

<tr>
<td>│  </td>
<td>├──</td>
<td>sources.json</td>
<td></td>
</tr>

<tr>
<td>│  </td>
<td>└──</td>
<td>sources.nix</td>
<td></td>
</tr>

<tr>
<td>└──</td>
<td>shell.nix</td>
<td></td>
<td></td>
</tr>

<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>

<tr>
<td>1</td>
<td>directory,</td>
<td>3</td>
<td>files</td>
</tr>
</tbody>
</table>

<p>We will have to update our <code>shell.nix</code> to use the new sources.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nix" data-lang="nix"><span style="color:#6ab825;font-weight:bold">let</span>
  sources = <span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">./nix/sources.nix</span>;
  pkgs = <span style="color:#6ab825;font-weight:bold">import</span> sources.nixpkgs { };
  stdenv = pkgs.stdenv;
  my-r-pkgs = pkgs.rWrapper.override {
    packages = <span style="color:#6ab825;font-weight:bold">with</span> pkgs.rPackages; [
      ggplot2
      tidyverse
      tidybayes
    ];
  };
<span style="color:#6ab825;font-weight:bold">in</span> pkgs.mkShell {
  buildInputs = <span style="color:#6ab825;font-weight:bold">with</span> pkgs;[ git glibcLocales openssl which openssh curl wget my-r-pkgs ];
  shellHook = <span style="color:#ed9d13">&#39;&#39;
</span><span style="color:#ed9d13">    mkdir -p &#34;$(pwd)/_libs&#34;
</span><span style="color:#ed9d13">    export R_LIBS_USER=&#34;$(pwd)/_libs&#34;
</span><span style="color:#ed9d13">  &#39;&#39;</span>;
  GIT_SSL_CAINFO = <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>pkgs.cacert<span style="color:#ed9d13">}</span><span style="color:#ed9d13">/etc/ssl/certs/ca-bundle.crt&#34;</span>;
  LOCALE_ARCHIVE = stdenv.lib.optionalString stdenv.isLinux
    <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>pkgs.glibcLocales<span style="color:#ed9d13">}</span><span style="color:#ed9d13">/lib/locale/locale-archive&#34;</span>;
}</code></pre></div>
<p>We could inspect and edit these sources by hand, but it is much more convenient
to simply use <code>niv</code> again when we need to update these.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#24909d">cd</span> tryRnix/
niv update nixpkgs -b nixpkgs-unstable</code></pre></div>
<p>At this stage we have a reproducible set of packages ready to use. However it is
still pretty annoying to have to go through the trouble of writing <code>nix-shell</code>
and also waiting while it rebuilds when we change things.</p>

<h3 id="lorri-and-direnv">Lorri and Direnv</h3>

<p><a href="https://rgoswami.me/posts/poetry-direnv/" target="_blank">In the past</a>, I have made my admiration for <code>direnv</code> very clear (especially for
<code>python-poetry</code>). However, though <code>direnv</code> does allow us to include arbitrary <code>bash</code> logic into our projects, it would be nice to have something which has some defaults for nix. Thankfully, the folks at TweagIO developed <a href="https://github.com/target/lorri" target="_blank">lorri</a> to scratch that itch.</p>

<p>The basic setup is simple:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nix-env -i lorri
<span style="color:#24909d">cd</span> tryRnix/
lorri init</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tree -a tryRnix/</code></pre></div>
<table>
<thead>
<tr>
<th>tryRnix/</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>├──</td>
<td>.envrc</td>
<td></td>
<td></td>
</tr>

<tr>
<td>├──</td>
<td>nix</td>
<td></td>
<td></td>
</tr>

<tr>
<td>│  </td>
<td>├──</td>
<td>sources.json</td>
<td></td>
</tr>

<tr>
<td>│  </td>
<td>└──</td>
<td>sources.nix</td>
<td></td>
</tr>

<tr>
<td>└──</td>
<td>shell.nix</td>
<td></td>
<td></td>
</tr>

<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>

<tr>
<td>1</td>
<td>directory,</td>
<td>4</td>
<td>files</td>
</tr>
</tbody>
</table>

<p>We can and should inspect the environment <code>lorri</code> wants us to load with <code>direnv</code> file:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat tryRnix/.envrc</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$(lorri direnv)</code></pre></div>
<p>In and of itself that is not too descriptive, so we should run  that on our own first.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#40ffff">EVALUATION_ROOT</span>=<span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$HOME</span><span style="color:#ed9d13">/.cache/lorri/gc_roots/407bd4df60fbda6e3a656c39f81c03c2/gc_root/shell_gc_root&#34;</span>

watch_file <span style="color:#ed9d13">&#34;/run/user/1000/lorri/daemon.socket&#34;</span>
watch_file <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">&#34;</span>

<span style="color:#999;font-style:italic">#!/usr/bin/env bash</span>
<span style="color:#999;font-style:italic"># ^ shebang is unused as this file is sourced, but present for editor</span>
<span style="color:#999;font-style:italic"># integration. Note: Direnv guarantees it *will* be parsed using bash.</span>

<span style="color:#6ab825;font-weight:bold">function</span> punt () {
    :
}

<span style="color:#999;font-style:italic"># move &#34;origPreHook&#34; &#34;preHook&#34; &#34;$@&#34;;;</span>
move() {
    <span style="color:#40ffff">srcvarname</span>=<span style="color:#40ffff">$1</span> <span style="color:#999;font-style:italic"># example: varname might contain the string &#34;origPATH&#34;</span>
    <span style="color:#999;font-style:italic"># drop off the source variable name</span>
    <span style="color:#24909d">shift</span>

    <span style="color:#40ffff">destvarname</span>=<span style="color:#40ffff">$1</span> <span style="color:#999;font-style:italic"># example: destvarname might contain the string &#34;PATH&#34;</span>
    <span style="color:#999;font-style:italic"># drop off the destination variable name</span>
    <span style="color:#24909d">shift</span>

    <span style="color:#999;font-style:italic"># like: export origPATH=&#34;...some-value...&#34;</span>
    <span style="color:#24909d">export</span> <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>@?<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>;

    <span style="color:#999;font-style:italic"># set $original to the contents of the variable $srcvarname</span>
    <span style="color:#999;font-style:italic"># refers to</span>
    <span style="color:#24909d">eval</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$destvarname</span><span style="color:#ed9d13">=\&#34;</span><span style="color:#ed9d13">${</span>!srcvarname<span style="color:#ed9d13">}</span><span style="color:#ed9d13">\&#34;&#34;</span>

    <span style="color:#999;font-style:italic"># mark the destvarname as exported so direnv picks it up</span>
    <span style="color:#999;font-style:italic"># (shellcheck: we do want to export the content of destvarname!)</span>
    <span style="color:#999;font-style:italic"># shellcheck disable=SC2163</span>
    <span style="color:#24909d">export</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$destvarname</span><span style="color:#ed9d13">&#34;</span>

    <span style="color:#999;font-style:italic"># remove the export from above, ie: export origPATH...</span>
    <span style="color:#24909d">unset</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$srcvarname</span><span style="color:#ed9d13">&#34;</span>
}

<span style="color:#6ab825;font-weight:bold">function</span> prepend() {
    <span style="color:#40ffff">varname</span>=<span style="color:#40ffff">$1</span> <span style="color:#999;font-style:italic"># example: varname might contain the string &#34;PATH&#34;</span>

    <span style="color:#999;font-style:italic"># drop off the varname</span>
    <span style="color:#24909d">shift</span>

    <span style="color:#40ffff">separator</span>=<span style="color:#40ffff">$1</span> <span style="color:#999;font-style:italic"># example: separator would usually be the string &#34;:&#34;</span>

    <span style="color:#999;font-style:italic"># drop off the separator argument, so the remaining arguments</span>
    <span style="color:#999;font-style:italic"># are the arguments to export</span>
    <span style="color:#24909d">shift</span>

    <span style="color:#999;font-style:italic"># set $original to the contents of the the variable $varname</span>
    <span style="color:#999;font-style:italic"># refers to</span>
    <span style="color:#40ffff">original</span>=<span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>!varname<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>

    <span style="color:#999;font-style:italic"># effectfully accept the new variable&#39;s contents</span>
    <span style="color:#24909d">export</span> <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>@?<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>;

    <span style="color:#999;font-style:italic"># re-set $varname&#39;s variable to the contents of varname&#39;s</span>
    <span style="color:#999;font-style:italic"># reference, plus the current (updated on the export) contents.</span>
    <span style="color:#999;font-style:italic"># however, exclude the ${separator} unless ${original} starts</span>
    <span style="color:#999;font-style:italic"># with a value</span>
    <span style="color:#24909d">eval</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$varname</span><span style="color:#ed9d13">=</span><span style="color:#ed9d13">${</span>!varname<span style="color:#ed9d13">}${</span><span style="color:#40ffff">original</span>:+<span style="color:#ed9d13">${</span><span style="color:#40ffff">separator</span><span style="color:#ed9d13">}${</span><span style="color:#40ffff">original</span><span style="color:#ed9d13">}}</span><span style="color:#ed9d13">&#34;</span>
}

<span style="color:#6ab825;font-weight:bold">function</span> append() {
    <span style="color:#40ffff">varname</span>=<span style="color:#40ffff">$1</span> <span style="color:#999;font-style:italic"># example: varname might contain the string &#34;PATH&#34;</span>

    <span style="color:#999;font-style:italic"># drop off the varname</span>
    <span style="color:#24909d">shift</span>

    <span style="color:#40ffff">separator</span>=<span style="color:#40ffff">$1</span> <span style="color:#999;font-style:italic"># example: separator would usually be the string &#34;:&#34;</span>
    <span style="color:#999;font-style:italic"># drop off the separator argument, so the remaining arguments</span>
    <span style="color:#999;font-style:italic"># are the arguments to export</span>
    <span style="color:#24909d">shift</span>


    <span style="color:#999;font-style:italic"># set $original to the contents of the the variable $varname</span>
    <span style="color:#999;font-style:italic"># refers to</span>
    <span style="color:#40ffff">original</span>=<span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>!varname<span style="color:#6ab825;font-weight:bold">:-</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>

    <span style="color:#999;font-style:italic"># effectfully accept the new variable&#39;s contents</span>
    <span style="color:#24909d">export</span> <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>@?<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>;

    <span style="color:#999;font-style:italic"># re-set $varname&#39;s variable to the contents of varname&#39;s</span>
    <span style="color:#999;font-style:italic"># reference, plus the current (updated on the export) contents.</span>
    <span style="color:#999;font-style:italic"># however, exclude the ${separator} unless ${original} starts</span>
    <span style="color:#999;font-style:italic"># with a value</span>
    <span style="color:#24909d">eval</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$varname</span><span style="color:#ed9d13">=</span><span style="color:#ed9d13">${</span><span style="color:#40ffff">original</span>:+<span style="color:#ed9d13">${</span><span style="color:#40ffff">original</span><span style="color:#ed9d13">}${</span><span style="color:#40ffff">separator</span><span style="color:#ed9d13">}}${</span>!varname<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>
}

varmap() {
    <span style="color:#6ab825;font-weight:bold">if</span> [ -f <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">/varmap-v1&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
        <span style="color:#999;font-style:italic"># Capture the name of the variable being set</span>
        <span style="color:#40ffff">IFS</span>=<span style="color:#ed9d13">&#34;=&#34;</span> <span style="color:#24909d">read</span> -r -a cur_varname &lt;&lt;&lt; <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$1</span><span style="color:#ed9d13">&#34;</span>

        <span style="color:#999;font-style:italic"># With IFS=&#39;&#39; and the `read` delimiter being &#39;&#39;, we achieve</span>
        <span style="color:#999;font-style:italic"># splitting on \0 bytes while also preserving leading</span>
        <span style="color:#999;font-style:italic"># whitespace:</span>
        #
        <span style="color:#999;font-style:italic">#    bash-3.2$ printf &#39; &lt;- leading space\0bar\0baz\0&#39; \</span>
        <span style="color:#999;font-style:italic">#                  | (while IFS=&#39;&#39; read -d $&#39;\0&#39; -r x; do echo &#34;&gt;$x&lt;&#34;; done)</span>
        <span style="color:#999;font-style:italic">#    &gt; &lt;- leading space&lt;</span>
        <span style="color:#999;font-style:italic">#    &gt;bar&lt;</span>
        <span style="color:#999;font-style:italic">#    &gt;baz&lt;```</span>
        <span style="color:#6ab825;font-weight:bold">while</span> <span style="color:#40ffff">IFS</span>=<span style="color:#ed9d13">&#39;&#39;</span> <span style="color:#24909d">read</span> -r -d <span style="color:#ed9d13">&#39;&#39;</span> map_instruction <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           &amp;&amp; <span style="color:#40ffff">IFS</span>=<span style="color:#ed9d13">&#39;&#39;</span> <span style="color:#24909d">read</span> -r -d <span style="color:#ed9d13">&#39;&#39;</span> map_variable <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           &amp;&amp; <span style="color:#40ffff">IFS</span>=<span style="color:#ed9d13">&#39;&#39;</span> <span style="color:#24909d">read</span> -r -d <span style="color:#ed9d13">&#39;&#39;</span> map_separator; <span style="color:#6ab825;font-weight:bold">do</span>
            <span style="color:#24909d">unset</span> IFS

            <span style="color:#6ab825;font-weight:bold">if</span> [ <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$map_variable</span><span style="color:#ed9d13">&#34;</span> == <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span><span style="color:#40ffff">cur_varname</span>[0]<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
                <span style="color:#6ab825;font-weight:bold">if</span> [ <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$map_instruction</span><span style="color:#ed9d13">&#34;</span> == <span style="color:#ed9d13">&#34;append&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
                    append <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$map_variable</span><span style="color:#ed9d13">&#34;</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$map_separator</span><span style="color:#ed9d13">&#34;</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$@</span><span style="color:#ed9d13">&#34;</span>
                    <span style="color:#6ab825;font-weight:bold">return</span>
                <span style="color:#6ab825;font-weight:bold">fi</span>
            <span style="color:#6ab825;font-weight:bold">fi</span>
        <span style="color:#6ab825;font-weight:bold">done</span> &lt; <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">/varmap-v1&#34;</span>
    <span style="color:#6ab825;font-weight:bold">fi</span>


    <span style="color:#24909d">export</span> <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>@?<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span>
}

<span style="color:#6ab825;font-weight:bold">function</span> declare() {
    <span style="color:#6ab825;font-weight:bold">if</span> [ <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$1</span><span style="color:#ed9d13">&#34;</span> == <span style="color:#ed9d13">&#34;-x&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span> shift; <span style="color:#6ab825;font-weight:bold">fi</span>

    <span style="color:#999;font-style:italic"># Some variables require special handling.</span>
    #
    <span style="color:#999;font-style:italic"># - punt:    don&#39;t set the variable at all</span>
    <span style="color:#999;font-style:italic"># - prepend: take the new value, and put it before the current value.</span>
    <span style="color:#6ab825;font-weight:bold">case</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$1</span><span style="color:#ed9d13">&#34;</span> in
        <span style="color:#999;font-style:italic"># vars from: https://github.com/NixOS/nix/blob/92d08c02c84be34ec0df56ed718526c382845d1a/src/nix-build/nix-build.cc#L100</span>
        <span style="color:#ed9d13">&#34;HOME=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;USER=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;LOGNAME=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;DISPLAY=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;PATH=&#34;</span>*) prepend <span style="color:#ed9d13">&#34;PATH&#34;</span> <span style="color:#ed9d13">&#34;:&#34;</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$@</span><span style="color:#ed9d13">&#34;</span>;;
        <span style="color:#ed9d13">&#34;TERM=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;IN_NIX_SHELL=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;TZ=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;PAGER=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;NIX_BUILD_SHELL=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;SHLVL=&#34;</span>*) punt;;

        <span style="color:#999;font-style:italic"># vars from: https://github.com/NixOS/nix/blob/92d08c02c84be34ec0df56ed718526c382845d1a/src/nix-build/nix-build.cc#L385</span>
        <span style="color:#ed9d13">&#34;TEMPDIR=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;TMPDIR=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;TEMP=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;TMP=&#34;</span>*) punt;;

        <span style="color:#999;font-style:italic"># vars from: https://github.com/NixOS/nix/blob/92d08c02c84be34ec0df56ed718526c382845d1a/src/nix-build/nix-build.cc#L421</span>
        <span style="color:#ed9d13">&#34;NIX_ENFORCE_PURITY=&#34;</span>*) punt;;

        <span style="color:#999;font-style:italic"># vars from: https://www.gnu.org/software/bash/manual/html_node/Bash-Variables.html (last checked: 2019-09-26)</span>
        <span style="color:#999;font-style:italic"># reported in https://github.com/target/lorri/issues/153</span>
        <span style="color:#ed9d13">&#34;OLDPWD=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;PWD=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;SHELL=&#34;</span>*) punt;;

        <span style="color:#999;font-style:italic"># https://github.com/target/lorri/issues/97</span>
        <span style="color:#ed9d13">&#34;preHook=&#34;</span>*) punt;;
        <span style="color:#ed9d13">&#34;origPreHook=&#34;</span>*) move <span style="color:#ed9d13">&#34;origPreHook&#34;</span> <span style="color:#ed9d13">&#34;preHook&#34;</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$@</span><span style="color:#ed9d13">&#34;</span>;;

        *) varmap <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$@</span><span style="color:#ed9d13">&#34;</span> ;;
    <span style="color:#6ab825;font-weight:bold">esac</span>
}

<span style="color:#24909d">export</span> <span style="color:#40ffff">IN_NIX_SHELL</span>=impure

<span style="color:#6ab825;font-weight:bold">if</span> [ -f <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">/bash-export&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
    <span style="color:#999;font-style:italic"># shellcheck disable=SC1090</span>
    . <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">/bash-export&#34;</span>
<span style="color:#6ab825;font-weight:bold">elif</span> [ -f <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
    <span style="color:#999;font-style:italic"># shellcheck disable=SC1090</span>
    . <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$EVALUATION_ROOT</span><span style="color:#ed9d13">&#34;</span>
<span style="color:#6ab825;font-weight:bold">fi</span>

<span style="color:#24909d">unset</span> <span style="color:#24909d">declare</span>

Jun <span style="color:#3677a9">06</span> <span style="color:#3677a9">19</span>:02:32.368 INFO lorri has not completed an evaluation <span style="color:#6ab825;font-weight:bold">for</span> this project yet, expr: <span style="color:#40ffff">$HOME</span>/Git/Github/WebDev/Mine/haozeke.github.io/content-org/tryRnix/shell.nix
Jun <span style="color:#3677a9">06</span> <span style="color:#3677a9">19</span>:02:32.368 WARN <span style="color:#ed9d13">`</span>lorri direnv<span style="color:#ed9d13">`</span> should be executed by direnv from within an <span style="color:#ed9d13">`</span>.envrc<span style="color:#ed9d13">`</span> file, expr: <span style="color:#40ffff">$HOME</span>/Git/Github/WebDev/Mine/haozeke.github.io/content-org/tryRnix/shell.nix</code></pre></div>
<p>Upon inspection, that seems to check out. So now we can enable this.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">direnv allow</code></pre></div>
<p>Additionally, we will need to stick to using a pure environment as much as
possible to prevent unexpected situations. So we set:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># .envrc</span>
<span style="color:#24909d">eval</span> <span style="color:#ed9d13">&#34;</span><span style="color:#6ab825;font-weight:bold">$(</span>lorri direnv<span style="color:#6ab825;font-weight:bold">)</span><span style="color:#ed9d13">&#34;</span>
nix-shell --run bash --pure</code></pre></div>
<p>There&rsquo;s still a catch though. We need to have <code>lorri daemon</code> running to make
sure the packages are built automatically without us having to exit the shell
and re-run things. We can <a href="https://github.com/target/lorri/blob/master/contrib/daemon.md" target="_blank">turn to the documentation</a> for this. Essentially, we
need to have a user-level systemd socket file and service for <code>lorri</code>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># ~/.config/systemd/user/lorri.socket</span>
[Unit]
<span style="color:#40ffff">Description</span>=Socket <span style="color:#6ab825;font-weight:bold">for</span> Lorri Daemon

[Socket]
<span style="color:#40ffff">ListenStream</span>=%t/lorri/daemon.socket
<span style="color:#40ffff">RuntimeDirectory</span>=lorri

[Install]
<span style="color:#40ffff">WantedBy</span>=sockets.target</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># ~/.config/systemd/user/lorri.service</span>
[Unit]
<span style="color:#40ffff">Description</span>=Lorri Daemon
<span style="color:#40ffff">Requires</span>=lorri.socket
<span style="color:#40ffff">After</span>=lorri.socket

[Service]
<span style="color:#40ffff">ExecStart</span>=%h/.nix-profile/bin/lorri daemon
<span style="color:#40ffff">PrivateTmp</span>=<span style="color:#24909d">true</span>
<span style="color:#40ffff">ProtectSystem</span>=strict
<span style="color:#40ffff">ProtectHome</span>=read-only
<span style="color:#40ffff">Restart</span>=on-failure</code></pre></div>
<p>With that we are finally ready to start working with our auto-managed,
reproducible environments.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl --user daemon-reload &amp;&amp; <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>systemctl --user <span style="color:#24909d">enable</span> --now lorri.socket</code></pre></div>
<h2 id="rethinking">Rethinking</h2>

<p>As promised, we will first test the setup to see that everything is working. Now
is also a good time to try the <code>tidybayes.rethinking</code> package. In order to use
it, we will need to define the <code>rethinking</code> package in a way so we can pass it
to the <code>buildInputs</code> for <code>tidybayes.rethinking</code>. We will modify new <code>shell.nix</code>
as follows:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nix" data-lang="nix"><span style="color:#999;font-style:italic"># shell.nix</span>
<span style="color:#6ab825;font-weight:bold">let</span>
  sources = <span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">./nix/sources.nix</span>;
  pkgs = <span style="color:#6ab825;font-weight:bold">import</span> sources.nixpkgs { };
  stdenv = pkgs.stdenv;
  rethinking = <span style="color:#6ab825;font-weight:bold">with</span> pkgs.rPackages;
    buildRPackage {
      name = <span style="color:#ed9d13">&#34;rethinking&#34;</span>;
      src = pkgs.fetchFromGitHub {
        owner = <span style="color:#ed9d13">&#34;rmcelreath&#34;</span>;
        repo = <span style="color:#ed9d13">&#34;rethinking&#34;</span>;
        rev = <span style="color:#ed9d13">&#34;d0978c7f8b6329b94efa2014658d750ae12b1fa2&#34;</span>;
        sha256 = <span style="color:#ed9d13">&#34;1qip6x3f6j9lmcmck6sjrj50a5azqfl6rfhp4fdj7ddabpb8n0z0&#34;</span>;
      };
      propagatedBuildInputs = [ coda MASS mvtnorm loo shape rstan dagitty ];
    };
  tidybayes_rethinking = <span style="color:#6ab825;font-weight:bold">with</span> pkgs.rPackages;
    buildRPackage {
      name = <span style="color:#ed9d13">&#34;tidybayes.rethinking&#34;</span>;
      src = pkgs.fetchFromGitHub {
        owner = <span style="color:#ed9d13">&#34;mjskay&#34;</span>;
        repo = <span style="color:#ed9d13">&#34;tidybayes.rethinking&#34;</span>;
        rev = <span style="color:#ed9d13">&#34;df903c88f4f4320795a47c616eef24a690b433a4&#34;</span>;
        sha256 = <span style="color:#ed9d13">&#34;1jl3189zdddmwm07z1mk58hcahirqrwx211ms0i1rzbx5y4zak0c&#34;</span>;
      };
      propagatedBuildInputs =
        [ dplyr tibble rlang MASS tidybayes rethinking rstan ];
    };
  rEnv = pkgs.rWrapper.override {
    packages = <span style="color:#6ab825;font-weight:bold">with</span> pkgs.rPackages; [
      ggplot2
      tidyverse
      tidybayes
      devtools
      modelr
      cowplot
      ggrepel
      RColorBrewer
      purrr
      forcats
      rstan
      rethinking
      tidybayes_rethinking
    ];
  };
<span style="color:#6ab825;font-weight:bold">in</span> pkgs.mkShell {
  buildInputs = <span style="color:#6ab825;font-weight:bold">with</span> pkgs; [ git glibcLocales which ];
  inputsFrom = [ rEnv ];
  shellHook = <span style="color:#ed9d13">&#39;&#39;
</span><span style="color:#ed9d13">    mkdir -p &#34;$(pwd)/_libs&#34;
</span><span style="color:#ed9d13">    export R_LIBS_USER=&#34;$(pwd)/_libs&#34;
</span><span style="color:#ed9d13">  &#39;&#39;</span>;
  GIT_SSL_CAINFO = <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>pkgs.cacert<span style="color:#ed9d13">}</span><span style="color:#ed9d13">/etc/ssl/certs/ca-bundle.crt&#34;</span>;
  LOCALE_ARCHIVE = stdenv.lib.optionalString stdenv.isLinux
    <span style="color:#ed9d13">&#34;</span><span style="color:#ed9d13">${</span>pkgs.glibcLocales<span style="color:#ed9d13">}</span><span style="color:#ed9d13">/lib/locale/locale-archive&#34;</span>;
}</code></pre></div>
<p>The main thing to note here is that we need the output of the derivation we
create here, i.e. we need to use <code>inputsFrom</code> and NOT <code>buildInputs</code> for <code>rEnv</code>.</p>

<p>Let us try to get a nice graphic for the conclusion.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#447fcf">library</span>(magrittr)
<span style="color:#447fcf">library</span>(dplyr)
<span style="color:#447fcf">library</span>(purrr)
<span style="color:#447fcf">library</span>(forcats)
<span style="color:#447fcf">library</span>(tidyr)
<span style="color:#447fcf">library</span>(modelr)
<span style="color:#447fcf">library</span>(tidybayes)
<span style="color:#447fcf">library</span>(tidybayes.rethinking)
<span style="color:#447fcf">library</span>(ggplot2)
<span style="color:#447fcf">library</span>(cowplot)
<span style="color:#447fcf">library</span>(rstan)
<span style="color:#447fcf">library</span>(rethinking)
<span style="color:#447fcf">library</span>(ggrepel)
<span style="color:#447fcf">library</span>(RColorBrewer)

<span style="color:#447fcf">theme_set</span>(<span style="color:#447fcf">theme_tidybayes</span>())
<span style="color:#447fcf">rstan_options</span>(auto_write = <span style="color:#6ab825;font-weight:bold">TRUE</span>)
<span style="color:#447fcf">options</span>(mc.cores = parallel::<span style="color:#447fcf">detectCores</span>())


<span style="color:#447fcf">set.seed</span>(<span style="color:#3677a9">5</span>)
n = <span style="color:#3677a9">10</span>
n_condition = <span style="color:#3677a9">5</span>
ABC =
  <span style="color:#447fcf">tibble</span>(
    condition = <span style="color:#447fcf">factor</span>(<span style="color:#447fcf">rep</span>(<span style="color:#447fcf">c</span>(<span style="color:#ed9d13">&#34;A&#34;</span>,<span style="color:#ed9d13">&#34;B&#34;</span>,<span style="color:#ed9d13">&#34;C&#34;</span>,<span style="color:#ed9d13">&#34;D&#34;</span>,<span style="color:#ed9d13">&#34;E&#34;</span>), n)),
    response = <span style="color:#447fcf">rnorm</span>(n * <span style="color:#3677a9">5</span>, <span style="color:#447fcf">c</span>(<span style="color:#3677a9">0</span>,<span style="color:#3677a9">1</span>,<span style="color:#3677a9">2</span>,<span style="color:#3677a9">1</span>,<span style="color:#3677a9">-1</span>), <span style="color:#3677a9">0.5</span>)
  )

mtcars_clean = mtcars %&gt;%
  <span style="color:#447fcf">mutate</span>(cyl = <span style="color:#447fcf">factor</span>(cyl))

m_cyl = <span style="color:#447fcf">ulam</span>(<span style="color:#447fcf">alist</span>(
    cyl ~ <span style="color:#447fcf">dordlogit</span>(phi, cutpoint),
    phi &lt;- b_mpg*mpg,
    b_mpg ~ <span style="color:#447fcf">student_t</span>(<span style="color:#3677a9">3</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">10</span>),
    cutpoint ~ <span style="color:#447fcf">student_t</span>(<span style="color:#3677a9">3</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">10</span>)
  ),
  data = mtcars_clean,
  chains = <span style="color:#3677a9">4</span>,
  cores = parallel::<span style="color:#447fcf">detectCores</span>(),
  iter = <span style="color:#3677a9">2000</span>
)

cutpoints = m_cyl %&gt;%
  <span style="color:#447fcf">recover_types</span>(mtcars_clean) %&gt;%
  <span style="color:#447fcf">spread_draws</span>(cutpoint[cyl])

<span style="color:#999;font-style:italic"># define the last cutpoint</span>
last_cutpoint = <span style="color:#447fcf">tibble</span>(
  .draw = <span style="color:#3677a9">1</span>:<span style="color:#447fcf">max</span>(cutpoints$.draw),
  cyl = <span style="color:#ed9d13">&#34;8&#34;</span>,
  cutpoint = <span style="color:#6ab825;font-weight:bold">Inf</span>
)

cutpoints = <span style="color:#447fcf">bind_rows</span>(cutpoints, last_cutpoint) %&gt;%
  <span style="color:#999;font-style:italic"># define the previous cutpoint (cutpoint_{j-1})</span>
  <span style="color:#447fcf">group_by</span>(.draw) %&gt;%
  <span style="color:#447fcf">arrange</span>(cyl) %&gt;%
  <span style="color:#447fcf">mutate</span>(prev_cutpoint = <span style="color:#447fcf">lag</span>(cutpoint, default = -<span style="color:#6ab825;font-weight:bold">Inf</span>))

fitted_cyl_probs = mtcars_clean %&gt;%
  <span style="color:#447fcf">data_grid</span>(mpg = <span style="color:#447fcf">seq_range</span>(mpg, n = <span style="color:#3677a9">101</span>)) %&gt;%
  <span style="color:#447fcf">add_fitted_draws</span>(m_cyl) %&gt;%
  <span style="color:#447fcf">inner_join</span>(cutpoints, by = <span style="color:#ed9d13">&#34;.draw&#34;</span>) %&gt;%
  <span style="color:#447fcf">mutate</span>(<span style="color:#447fcf">`P</span>(cyl | mpg)` =
    # this part is logit^-1(cutpoint_j - beta*x) - logit^-1(cutpoint_{j-1} - beta*x)
    plogis(cutpoint - .value) - plogis(prev_cutpoint - .value)
  )


data_plot = mtcars_clean %&gt;%
  ggplot(aes(x = mpg, y = cyl, color = cyl)) +
  geom_point() +
  scale_color_brewer(palette = &#34;Dark2&#34;, name = &#34;cyl&#34;)

fit_plot = fitted_cyl_probs %&gt;%
  ggplot(aes(x = mpg, y = `<span style="color:#447fcf">P</span>(cyl | mpg)`, color = cyl)) +
  <span style="color:#447fcf">stat_lineribbon</span>(<span style="color:#447fcf">aes</span>(fill = cyl), alpha = <span style="color:#3677a9">1</span>/<span style="color:#3677a9">5</span>) +
  <span style="color:#447fcf">scale_color_brewer</span>(palette = <span style="color:#ed9d13">&#34;Dark2&#34;</span>) +
  <span style="color:#447fcf">scale_fill_brewer</span>(palette = <span style="color:#ed9d13">&#34;Dark2&#34;</span>)

<span style="color:#447fcf">png</span>(filename=<span style="color:#ed9d13">&#34;../images/rethinking.png&#34;</span>)
<span style="color:#447fcf">plot_grid</span>(ncol = <span style="color:#3677a9">1</span>, align = <span style="color:#ed9d13">&#34;v&#34;</span>,
  data_plot,
  fit_plot
)
dev.off</code></pre></div>
<p>Finally we will run this in our environment.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Rscript tesPlot.R</code></pre></div>
<figure>
    <img src="https://rgoswami.me/ox-hugo/rethinking.png"/> 
</figure>


<h2 id="conclusions">Conclusions</h2>

<p>This post was really more of an exploratory follow up to the previous post, and
does not really work in isolation. Then again, at this point everything seems to
have worked out well. <code>R</code> with Nix has finally become a truly viable combination
for any and every analysis under the sun. Some parts of the workflow are still a
bit janky, but will probably resolve themselves over time.</p>

<p><strong>Update:</strong> There is <a href="https://rgoswami.me/posts/emacs-nix-r/" target="_blank">a final part</a> detailing automated ways of reloading the system configuration</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:fn-1">My motivations were laid out in the <a href="https://rgoswami.me/posts/nix-r-devtools/" target="_blank">aforementioned post</a>, and will not be repeated
 <a class="footnote-return" href="#fnref:fn-1"><sup>[return]</sup></a></li>
<li id="fn:fn-2">For why these are the way they are see the this is written, see the <a href="https://rgoswami.me/posts/nix-r-devtools/" target="_blank">aforementioned post</a>
 <a class="footnote-return" href="#fnref:fn-2"><sup>[return]</sup></a></li>
<li id="fn:fn-3">Christine Dodrill <a href="https://christine.website/blog/how-i-start-nix-2020-03-08" target="_blank">has a great write up</a> on using these tools as well
 <a class="footnote-return" href="#fnref:fn-3"><sup>[return]</sup></a></li>
</ol>
</div>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://rgoswami.me/tags/tools">tools</a></span><span class="tag"><a href="https://rgoswami.me/tags/nix">nix</a></span><span class="tag"><a href="https://rgoswami.me/tags/workflow">workflow</a></span><span class="tag"><a href="https://rgoswami.me/tags/r">R</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2180 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-06-07 04:24 &#43;0000</p>
<a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target="_blank" rel="noopener" aria-label="Facebook">
  <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--circle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3 0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div>
</a>


<a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?text=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target="_blank" rel="noopener" aria-label="Twitter">
  <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--circle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3 0 1 .4 1.7 1.2 2.2-.5 0-1 0-1.2-.3 0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8 0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div>
</a>


<a class="resp-sharing-button__link" href="mailto:?subject=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...&amp;body=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target="_self" rel="noopener" aria-label="E-Mail">
  <div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--circle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8 0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8 0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6l-4-2.5m-7 2.5l4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div>
</a>


<a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f&amp;title=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...&amp;summary=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...&amp;source=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target="_blank" rel="noopener" aria-label="LinkedIn">
  <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--circle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28 0-.5.22-.5.5v3.5h-3s.03-6.48 0-7h3v.83s.46-.75 1.7-.75c1.56 0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div>
</a>


<a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f&amp;resubmit=true&amp;title=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting..." target="_blank" rel="noopener" aria-label="Reddit">
  <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--circle">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57-.88 0-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9 0 1.63.73 1.63 1.63 0 .8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9 0-1.63.73-1.63 1.63 0 .8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div>
</a>


<a class="resp-sharing-button__link" href="whatsapp://send?text=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target="_blank" rel="noopener" aria-label="WhatsApp">
  <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--circle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1px" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3 0-7.8 3.5-7.8 7.8 0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3 0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2 0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4 0-3.6 2.9-6.5 6.5-6.5 1.7 0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1-.1.2-.5.6-.6.8-.1.1-.2.1-.4 0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2 0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1 0-.2 0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3 0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9 0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div>
</a>
</div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Read other posts</span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://rgoswami.me/posts/emacs-nix-r/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Emacs for Nix-R</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://rgoswami.me/posts/nix-r-devtools/">
                                <span class="button__text">Nix with R and devtools</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
          <div id="comments" class="thin">
    <script src="https://utteranc.es/client.js"
        repo="haozeke/haozeke.github.io"
        issue-term="pathname"
        theme="photon-dark"
        label="Utterance 💬"
        crossorigin="anonymous"
        async>
</script>

</div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
                <span><a href="https://rgoswami.me">Rohit Goswami (HaoZeke)</a></span>
            
            <span><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>.</span>
            <span> <a href="https://rgoswami.me/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Theme <a href="https://rgoswami.me/posts/rationale/">details here</a></span>
        </div>
    </div>
</footer>

            
        </div>

        



<script src="https://rgoswami.me/bundle.min.582d94d7fb9230fda38dd4c9d5ca8014cab7228a34654fe3c3476fc00178e03398e53906f6f25d759a6e29f36ae005e4ddbed05e05a31f3c3febc33bd0e89c58.js" integrity="sha512-WC2U1/uSMP2jjdTJ1cqAFMq3Ioo0ZU/jw0dvwAF44DOY5TkG9vJddZpuKfNq4AXk3b7QXgWjHzw/68M70OicWA=="></script>
<script data-goatcounter="https://rgoswami.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>



    </body>
</html>
